<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tournament Manager - Find Tournament</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="dashboard.html" class="navbar-brand">TournamentHub</a>
      <ul class="navbar-menu">
        <li><a href="dashboard.html" class="navbar-link">Dashboard</a></li>
        <li><a href="find-tournament.html" class="navbar-link">Find Tournament</a></li>
        <li><a href="create-tournament.html" class="navbar-link">Create Tournament</a></li>
        <li><a href="profile.html" class="navbar-link">Profile</a></li>
        <li><a href="#" id="logoutBtn" class="navbar-link">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="page">
    <div class="container">
      <div class="page-header">
        <h2 class="page-title">Find Tournament</h2>
        <p class="page-description">Enter a tournament code to join</p>
      </div>

      <div id="alertContainer"></div>

      <div class="card" style="max-width: 600px; margin: 0 auto;">
        <form id="searchForm">
          <div class="form-group">
            <label class="form-label" for="tournamentCode">Tournament Code</label>
            <input 
              type="text" 
              id="tournamentCode" 
              class="form-input" 
              placeholder="e.g., K4F8N" 
              style="text-transform: uppercase; font-size: 24px; text-align: center; font-weight: 700;"
              required
            >
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            Search Tournament
          </button>
        </form>
      </div>

      <div id="tournamentResult" class="hidden" style="max-width: 800px; margin: 32px auto 0;">
        <div class="card">
          <div class="flex-between" style="margin-bottom: 24px;">
            <div>
              <h3 class="card-title" id="tournamentName"></h3>
              <p class="card-description" id="tournamentDescription"></p>
            </div>
            <span class="badge badge-active" id="tournamentStatus"></span>
          </div>

          <div class="grid grid-2" style="margin-bottom: 24px;">
            <div>
              <div class="small" style="color: var(--text-secondary); margin-bottom: 4px;">Start Date</div>
              <div class="body-strong" id="startDate"></div>
            </div>
            <div>
              <div class="small" style="color: var(--text-secondary); margin-bottom: 4px;">Format</div>
              <div class="body-strong" id="format"></div>
            </div>
            <div>
              <div class="small" style="color: var(--text-secondary); margin-bottom: 4px;">Created By</div>
              <div class="body-strong" id="createdBy"></div>
            </div>
            <div>
              <div class="small" style="color: var(--text-secondary); margin-bottom: 4px;">Round Repeats</div>
              <div class="body-strong" id="roundRepeats"></div>
            </div>
          </div>

          <div id="joinSection">
            <button id="joinBtn" class="btn btn-primary" style="width: 100%;">
              Request to Join Tournament
            </button>
          </div>

          <div id="pendingSection" class="hidden">
            <div class="alert alert-info">
              Your request to join is pending admin approval
            </div>
          </div>

          <div id="approvedSection" class="hidden">
            <div class="alert alert-success">
              You are already a participant in this tournament
            </div>
            <button onclick="viewTournament()" class="btn btn-primary" style="width: 100%; margin-top: 16px;">
              View Tournament
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script>
    checkAuth();

    let currentTournament = null;

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    });

    // Auto-uppercase tournament code
    document.getElementById('tournamentCode').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });

    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const code = document.getElementById('tournamentCode').value.trim();

      try {
        const response = await fetch(`http://localhost:3000/api/tournaments/code/${code}`);
        
        if (!response.ok) {
          showAlert('Tournament not found', 'error');
          document.getElementById('tournamentResult').classList.add('hidden');
          return;
        }

        const tournament = await response.json();
        currentTournament = tournament;

        // Display tournament details
        document.getElementById('tournamentName').textContent = tournament.name;
        document.getElementById('tournamentDescription').textContent = tournament.description || 'No description';
        document.getElementById('tournamentStatus').textContent = tournament.status;
        document.getElementById('startDate').textContent = new Date(tournament.start_date).toLocaleDateString();
        document.getElementById('format').textContent = 'Round-Robin';
        document.getElementById('createdBy').textContent = tournament.creator_name;
        document.getElementById('roundRepeats').textContent = `${tournament.round_repeats}x`;

        document.getElementById('tournamentResult').classList.remove('hidden');

        // Check if user is already a participant
        await checkParticipation(tournament.id);

      } catch (error) {
        console.error('Error:', error);
        showAlert('Error searching for tournament', 'error');
      }
    });

    async function checkParticipation(tournamentId) {
      const user = getCurrentUser();

      try {
        const response = await fetch(`http://localhost:3000/api/tournaments/${tournamentId}/participants`);
        const participants = await response.json();

        const userParticipant = participants.find(p => p.user_id === user.id);

        if (userParticipant) {
          if (userParticipant.status === 'approved') {
            document.getElementById('joinSection').classList.add('hidden');
            document.getElementById('pendingSection').classList.add('hidden');
            document.getElementById('approvedSection').classList.remove('hidden');
          } else if (userParticipant.status === 'pending') {
            document.getElementById('joinSection').classList.add('hidden');
            document.getElementById('pendingSection').classList.remove('hidden');
            document.getElementById('approvedSection').classList.add('hidden');
          }
        } else {
          // Also check pending requests
          const pendingResponse = await fetch(`http://localhost:3000/api/tournaments/${tournamentId}/pending-requests`);
          const pendingRequests = await pendingResponse.json();
          
          const userPending = pendingRequests.find(r => r.user_id === user.id);
          
          if (userPending) {
            document.getElementById('joinSection').classList.add('hidden');
            document.getElementById('pendingSection').classList.remove('hidden');
            document.getElementById('approvedSection').classList.add('hidden');
          } else {
            document.getElementById('joinSection').classList.remove('hidden');
            document.getElementById('pendingSection').classList.add('hidden');
            document.getElementById('approvedSection').classList.add('hidden');
          }
        }
      } catch (error) {
        console.error('Error checking participation:', error);
      }
    }

    document.getElementById('joinBtn').addEventListener('click', async () => {
      const user = getCurrentUser();

      try {
        const response = await fetch(`http://localhost:3000/api/tournaments/${currentTournament.id}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id })
        });

        const data = await response.json();

        if (response.ok) {
          showAlert('Join request submitted!', 'success');
          document.getElementById('joinSection').classList.add('hidden');
          document.getElementById('pendingSection').classList.remove('hidden');
        } else {
          showAlert(data.error || 'Failed to join tournament', 'error');
        }
      } catch (error) {
        showAlert('Network error. Please try again.', 'error');
      }
    });

    function viewTournament() {
      window.location.href = `tournament.html?id=${currentTournament.id}`;
    }

    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      window.scrollTo(0, 0);
      setTimeout(() => {
        alertContainer.innerHTML = '';
      }, 5000);
    }
  </script>
</body>
</html>
